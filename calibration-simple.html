<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç°¡æ˜“æ ¡æ­£ - æ‰‹å‹•æ¨™è¨˜</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            overflow: hidden;
            background: #000;
            font-family: Arial, sans-serif;
            touch-action: none;
        }

        /* å…¨è¢å¹•è¦†è“‹å±¤ */
        #calibrationLayer {
            position: absolute;
            width: 100vw;
            height: 100vh;
            cursor: crosshair;
        }

        /* å·²æ¨™è¨˜çš„é» */
        .marked-point {
            position: absolute;
            width: 60px;
            height: 60px;
            border: 5px solid #00ff88;
            border-radius: 50%;
            background: rgba(0, 255, 136, 0.3);
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #00ff88;
            font-weight: bold;
            font-size: 24px;
            box-shadow: 0 0 30px #00ff88;
            animation: ping 1.5s ease-in-out infinite;
            transform: translate(-50%, -50%);
        }

        @keyframes ping {
            0%, 100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 0.7; transform: translate(-50%, -50%) scale(1.1); }
        }

        /* é ‚éƒ¨æç¤º */
        .top-instruction {
            position: absolute;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: #00ff88;
            padding: 20px 40px;
            border-radius: 50px;
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            z-index: 100;
            animation: bounce 2s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-10px); }
        }

        /* é€²åº¦æ¢ */
        .progress {
            position: absolute;
            bottom: 150px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            max-width: 600px;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 20px;
            z-index: 100;
        }

        .progress-bar {
            width: 100%;
            height: 15px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #00d4ff);
            width: 0%;
            transition: width 0.3s;
            box-shadow: 0 0 20px #00ff88;
        }

        .progress-text {
            color: white;
            text-align: center;
            font-size: 18px;
        }

        /* åº•éƒ¨æŒ‰éˆ• */
        .bottom-controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
            z-index: 100;
        }

        .btn {
            padding: 18px 40px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
        }

        .btn-primary {
            background: linear-gradient(135deg, #00ff88, #00d4ff);
            color: #000;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            backdrop-filter: blur(10px);
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn.hidden {
            display: none;
        }

        /* æˆåŠŸç•«é¢ */
        .success-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }

        .success-content {
            text-align: center;
            color: white;
        }

        .success-icon {
            font-size: 100px;
            margin-bottom: 30px;
            animation: bounceIn 0.5s;
        }

        @keyframes bounceIn {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .success-content h1 {
            font-size: 48px;
            margin-bottom: 20px;
            color: #00ff88;
        }

        .success-content p {
            font-size: 24px;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <!-- æ ¡æ­£å±¤ -->
    <div id="calibrationLayer"></div>

    <!-- å·²æ¨™è¨˜çš„é»å®¹å™¨ -->
    <div id="markedPoints"></div>

    <!-- é ‚éƒ¨æç¤º -->
    <div class="top-instruction" id="instruction">
        ğŸ‘† é»æ“Šè¢å¹•æ¨™è¨˜:é» 1 (å·¦ä¸Šè§’)
    </div>

    <!-- é€²åº¦æ¢ -->
    <div class="progress">
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-text" id="progressText">
            å·²æ¨™è¨˜ 0/4 å€‹é»
        </div>
    </div>

    <!-- åº•éƒ¨æŒ‰éˆ• -->
    <div class="bottom-controls">
        <button class="btn btn-secondary" onclick="resetCalibration()">
            ğŸ”„ é‡æ–°æ¨™è¨˜
        </button>
        <button class="btn btn-primary hidden" id="completeBtn" onclick="complete()">
            âœ… å®Œæˆæ ¡æ­£
        </button>
    </div>

    <!-- æˆåŠŸç•«é¢ -->
    <div class="success-screen" id="successScreen">
        <div class="success-content">
            <div class="success-icon">âœ¨</div>
            <h1>æ ¡æ­£å®Œæˆ!</h1>
            <p>è®Šæ›çŸ©é™£å·²è¨ˆç®—ä¸¦å„²å­˜</p>
            <p style="margin-top: 20px; font-size: 18px;">å³å°‡è·³è½‰åˆ°è¨­å®šé é¢...</p>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let capturedPoints = [];
        let sessionId = null;
        
        const pointNames = [
            'é» 1 (å·¦ä¸Šè§’)',
            'é» 2 (å³ä¸Šè§’)',
            'é» 3 (å·¦ä¸‹è§’)',
            'é» 4 (å³ä¸‹è§’)'
        ];

        const instructions = [
            'ğŸ‘† é»æ“Šè¢å¹•æ¨™è¨˜:é» 1 (å·¦ä¸Šè§’)',
            'ğŸ‘† é»æ“Šè¢å¹•æ¨™è¨˜:é» 2 (å³ä¸Šè§’)',
            'ğŸ‘† é»æ“Šè¢å¹•æ¨™è¨˜:é» 3 (å·¦ä¸‹è§’)',
            'ğŸ‘† é»æ“Šè¢å¹•æ¨™è¨˜:é» 4 (å³ä¸‹è§’)'
        ];

        // åˆå§‹åŒ–
        function init() {
            console.log('ğŸ“ ç°¡æ˜“æ‰‹å‹•æ ¡æ­£æ¨¡å¼å•Ÿå‹•');

            // å–å¾— Session ID
            const urlParams = new URLSearchParams(window.location.search);
            sessionId = urlParams.get('session');
            
            if (!sessionId) {
                sessionId = 'MANUAL_' + Date.now();
                console.log('ç”Ÿæˆæ–°çš„ Session ID:', sessionId);
            }

            // é»æ“Šäº‹ä»¶
            document.getElementById('calibrationLayer').addEventListener('click', handleClick);
        }

        // è™•ç†é»æ“Š
        function handleClick(e) {
            if (capturedPoints.length >= 4) return;

            const x = e.clientX;
            const y = e.clientY;

            // å„²å­˜é»
            capturedPoints.push({
                x: x,
                y: y,
                screenX: (x / window.innerWidth) * 100,
                screenY: (y / window.innerHeight) * 100
            });

            console.log(`âœ… æ¨™è¨˜é» ${capturedPoints.length}:`, { x, y });

            // é¡¯ç¤ºæ¨™è¨˜
            addMarker(x, y, capturedPoints.length);

            // æ›´æ–°é€²åº¦
            updateProgress();

            // æ›´æ–°æŒ‡ç¤º
            if (capturedPoints.length < 4) {
                document.getElementById('instruction').textContent = instructions[capturedPoints.length];
            } else {
                document.getElementById('instruction').textContent = 'âœ… å·²æ¨™è¨˜æ‰€æœ‰é»!é»æ“Šã€Œå®Œæˆæ ¡æ­£ã€';
                document.getElementById('completeBtn').classList.remove('hidden');
            }

            // éœ‡å‹•å›é¥‹
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }

        // æ·»åŠ æ¨™è¨˜
        function addMarker(x, y, number) {
            const marker = document.createElement('div');
            marker.className = 'marked-point';
            marker.style.left = x + 'px';
            marker.style.top = y + 'px';
            marker.textContent = number;
            document.getElementById('markedPoints').appendChild(marker);
        }

        // æ›´æ–°é€²åº¦
        function updateProgress() {
            const progress = (capturedPoints.length / 4) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent = 
                `å·²æ¨™è¨˜ ${capturedPoints.length}/4 å€‹é»`;
        }

        // å®Œæˆæ ¡æ­£
        function complete() {
            console.log('ğŸ‰ æ ¡æ­£å®Œæˆ!');

            // å–å¾—æŠ•å½±é¡¯ç¤ºçš„é»åº§æ¨™
            let displayData = JSON.parse(localStorage.getItem('calibrationDisplayPoints') || '{}');
            
            // å¦‚æœæ²’æœ‰é¡¯ç¤ºåº§æ¨™,ä½¿ç”¨é è¨­å€¼(å››å€‹è§’)
            if (!displayData.displayPoints) {
                displayData = {
                    sessionId: sessionId,
                    displayPoints: {
                        point1: { x: 50, y: 50 },
                        point2: { x: window.innerWidth - 50, y: 50 },
                        point3: { x: 50, y: window.innerHeight - 50 },
                        point4: { x: window.innerWidth - 50, y: window.innerHeight - 50 }
                    },
                    screenWidth: window.innerWidth,
                    screenHeight: window.innerHeight
                };
            }

            // çµ„åˆæ ¡æ­£è³‡æ–™
            const calibrationData = {
                sessionId: sessionId,
                timestamp: Date.now(),
                displayPoints: displayData.displayPoints,
                capturedPoints: {
                    point1: capturedPoints[0],
                    point2: capturedPoints[1],
                    point3: capturedPoints[2],
                    point4: capturedPoints[3]
                },
                screenSize: {
                    width: window.innerWidth,
                    height: window.innerHeight
                }
            };

            // è¨ˆç®—è®Šæ›çŸ©é™£
            const matrix = calculateTransformMatrix(calibrationData);
            calibrationData.transformMatrix = matrix;

            // å„²å­˜
            localStorage.setItem('calibrationData', JSON.stringify(calibrationData));

            console.log('âœ… æ ¡æ­£è³‡æ–™å·²å„²å­˜:', calibrationData);

            // é¡¯ç¤ºæˆåŠŸç•«é¢
            document.getElementById('successScreen').style.display = 'flex';

            // 3 ç§’å¾Œè·³è½‰
            setTimeout(() => {
                window.location.href = '/setup-workflow.html';
            }, 3000);
        }

        // è¨ˆç®—è®Šæ›çŸ©é™£
        function calculateTransformMatrix(data) {
            const src = [
                [data.capturedPoints.point1.x, data.capturedPoints.point1.y],
                [data.capturedPoints.point2.x, data.capturedPoints.point2.y],
                [data.capturedPoints.point3.x, data.capturedPoints.point3.y],
                [data.capturedPoints.point4.x, data.capturedPoints.point4.y]
            ];

            const dst = [
                [data.displayPoints.point1.x, data.displayPoints.point1.y],
                [data.displayPoints.point2.x, data.displayPoints.point2.y],
                [data.displayPoints.point3.x, data.displayPoints.point3.y],
                [data.displayPoints.point4.x, data.displayPoints.point4.y]
            ];

            // è¨ˆç®—ç¸®æ”¾å’Œåç§»
            const scaleX = (dst[1][0] - dst[0][0]) / (src[1][0] - src[0][0]);
            const scaleY = (dst[2][1] - dst[0][1]) / (src[2][1] - src[0][1]);
            const offsetX = dst[0][0] - src[0][0] * scaleX;
            const offsetY = dst[0][1] - src[0][1] * scaleY;

            return {
                type: 'affine',
                srcPoints: src,
                dstPoints: dst,
                scaleX: scaleX,
                scaleY: scaleY,
                offsetX: offsetX,
                offsetY: offsetY
            };
        }

        // é‡ç½®
        function resetCalibration() {
            capturedPoints = [];
            document.getElementById('markedPoints').innerHTML = '';
            updateProgress();
            document.getElementById('instruction').textContent = instructions[0];
            document.getElementById('completeBtn').classList.add('hidden');
        }

        // å•Ÿå‹•
        window.addEventListener('load', init);
    </script>
</body>
</html>
