<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code é€£ç·šé é¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 100%;
            text-align: center;
        }

        h1 {
            color: #667eea;
            font-size: 32px;
            margin-bottom: 20px;
        }

        .instruction {
            color: #666;
            font-size: 16px;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .qr-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
        }

        .qr-section h2 {
            color: #333;
            font-size: 24px;
            margin-bottom: 15px;
        }

        .qr-code {
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
            display: inline-block;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .url-display {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 14px;
            word-break: break-all;
            color: #495057;
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: bold;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
        }

        .status.waiting {
            background: #fff3cd;
            color: #856404;
        }

        .button {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
            transition: transform 0.2s;
        }

        .button:hover {
            transform: translateY(-2px);
            background: #5568d3;
        }

        .button:active {
            transform: translateY(0);
        }

        .steps {
            text-align: left;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .steps ol {
            padding-left: 20px;
        }

        .steps li {
            margin: 10px 0;
            line-height: 1.6;
        }

        #detectedIP {
            color: #667eea;
            font-weight: bold;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ® æŠ•å½±éŠæˆ² QR Code</h1>
        
        <div class="instruction">
            ç”¨æ‰‹æ©Ÿæƒæä¸‹æ–¹ QR Code,å³å¯å¿«é€Ÿé€£æ¥åˆ°éŠæˆ²æ§åˆ¶å™¨!
        </div>

        <div class="status" id="status">
            <span id="statusText">æ­£åœ¨åµæ¸¬ç¶²è·¯...</span>
        </div>

        <!-- æ§åˆ¶å™¨ QR Code -->
        <div class="qr-section">
            <h2>ğŸ“± æ‰‹æ©Ÿæ§åˆ¶å™¨</h2>
            <div class="qr-code" id="controllerQR">
                <!-- QR Code æœƒåœ¨é€™è£¡ç”Ÿæˆ -->
            </div>
            <div class="url-display" id="controllerURL">
                æ­£åœ¨ç”Ÿæˆ...
            </div>
        </div>

        <!-- æŠ•å½±é¡¯ç¤º QR Code -->
        <div class="qr-section">
            <h2>ğŸ–¥ï¸ æŠ•å½±é¡¯ç¤º (å‚™ç”¨)</h2>
            <div class="qr-code" id="displayQR">
                <!-- QR Code æœƒåœ¨é€™è£¡ç”Ÿæˆ -->
            </div>
            <div class="url-display" id="displayURL">
                æ­£åœ¨ç”Ÿæˆ...
            </div>
        </div>

        <div class="steps">
            <strong>ğŸ“– ä½¿ç”¨æ­¥é©Ÿ:</strong>
            <ol>
                <li>ç¢ºä¿æ‰‹æ©Ÿå’Œé›»è…¦åœ¨<strong>åŒä¸€å€‹ WiFi</strong></li>
                <li>æ‰‹æ©Ÿæ‰“é–‹ç›¸æ©Ÿ App</li>
                <li>æƒæã€Œæ‰‹æ©Ÿæ§åˆ¶å™¨ã€çš„ QR Code</li>
                <li>æ‰‹æ©Ÿæœƒè‡ªå‹•é–‹å•Ÿæ§åˆ¶å™¨é é¢</li>
                <li>é»æ“Šå¤§æŒ‰éˆ•æ§åˆ¶è§’è‰²è·³èº!</li>
            </ol>
        </div>

        <button class="button" onclick="refreshQR()">ğŸ”„ é‡æ–°ç”Ÿæˆ QR Code</button>
        <button class="button" onclick="copyURL()">ğŸ“‹ è¤‡è£½æ§åˆ¶å™¨ç¶²å€</button>

        <div style="margin-top: 30px; color: #666; font-size: 14px;">
            åµæ¸¬åˆ°çš„ IP ä½å€: <span id="detectedIP">åµæ¸¬ä¸­...</span>
        </div>
    </div>

    <!-- QR Code ç”Ÿæˆå‡½å¼åº« -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    
    <script>
        let serverIP = '';
        let controllerQRCode = null;
        let displayQRCode = null;

        // åµæ¸¬æœ¬æ©Ÿ IP
        async function detectIP() {
            try {
                // æ–¹æ³• 1: ä½¿ç”¨ WebRTC
                const pc = new RTCPeerConnection({iceServers: []});
                pc.createDataChannel('');
                
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                
                return new Promise((resolve) => {
                    pc.onicecandidate = (ice) => {
                        if (!ice || !ice.candidate || !ice.candidate.candidate) return;
                        
                        const parts = ice.candidate.candidate.split(' ');
                        const ip = parts[4];
                        
                        if (ip && ip.match(/^192\.168\.|^10\.|^172\.(1[6-9]|2[0-9]|3[01])\./)) {
                            pc.close();
                            resolve(ip);
                        }
                    };
                    
                    // å‚™æ´:ç­‰å¾… 3 ç§’å¾Œä½¿ç”¨é è¨­ IP
                    setTimeout(() => {
                        resolve('192.168.68.101'); // ä½¿ç”¨ä¹‹å‰åµæ¸¬åˆ°çš„ IP
                    }, 3000);
                });
            } catch (error) {
                console.error('IP åµæ¸¬å¤±æ•—:', error);
                return '192.168.68.101'; // ä½¿ç”¨ä¹‹å‰åµæ¸¬åˆ°çš„ IP
            }
        }

        // ç”Ÿæˆ QR Code
        function generateQR() {
            const port = window.location.port || '8000';
            const controllerURL = `http://${serverIP}:${port}/index.html?mode=controller`;
            const displayURL = `http://${serverIP}:${port}/index.html?mode=display`;

            // é¡¯ç¤ºç¶²å€
            document.getElementById('controllerURL').textContent = controllerURL;
            document.getElementById('displayURL').textContent = displayURL;
            document.getElementById('detectedIP').textContent = serverIP;

            // æ¸…é™¤èˆŠçš„ QR Code
            document.getElementById('controllerQR').innerHTML = '';
            document.getElementById('displayQR').innerHTML = '';

            // ç”Ÿæˆæ–°çš„ QR Code
            controllerQRCode = new QRCode(document.getElementById('controllerQR'), {
                text: controllerURL,
                width: 256,
                height: 256,
                colorDark: '#667eea',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.H
            });

            displayQRCode = new QRCode(document.getElementById('displayQR'), {
                text: displayURL,
                width: 256,
                height: 256,
                colorDark: '#2ecc71',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.H
            });

            // æ›´æ–°ç‹€æ…‹
            const statusEl = document.getElementById('status');
            statusEl.className = 'status success';
            document.getElementById('statusText').textContent = `âœ… QR Code å·²ç”Ÿæˆ!ä¼ºæœå™¨ä½å€: ${serverIP}`;
        }

        // é‡æ–°ç”Ÿæˆ QR Code
        async function refreshQR() {
            document.getElementById('statusText').textContent = 'æ­£åœ¨åµæ¸¬ç¶²è·¯...';
            serverIP = await detectIP();
            generateQR();
        }

        // è¤‡è£½ç¶²å€
        function copyURL() {
            const port = window.location.port || '8000';
            const url = `http://${serverIP}:${port}/index.html?mode=controller`;
            
            navigator.clipboard.writeText(url).then(() => {
                alert('âœ… æ§åˆ¶å™¨ç¶²å€å·²è¤‡è£½!\n\n' + url + '\n\nå¯ä»¥ç›´æ¥å‚³é€çµ¦æ‰‹æ©Ÿæˆ–åœ¨æ‰‹æ©Ÿç€è¦½å™¨è²¼ä¸Šã€‚');
            }).catch(err => {
                alert('ç¶²å€:\n' + url + '\n\nè«‹æ‰‹å‹•è¤‡è£½æ­¤ç¶²å€åˆ°æ‰‹æ©Ÿç€è¦½å™¨ã€‚');
            });
        }

        // åˆå§‹åŒ–
        async function init() {
            console.log('ğŸ® QR Code é é¢å•Ÿå‹•');
            
            // å¾ URL è®€å– IP (å¦‚æœæœ‰çš„è©±)
            const urlParams = new URLSearchParams(window.location.search);
            const urlIP = urlParams.get('ip');
            
            if (urlIP) {
                serverIP = urlIP;
                console.log('ä½¿ç”¨ URL æä¾›çš„ IP:', serverIP);
            } else {
                console.log('é–‹å§‹åµæ¸¬æœ¬æ©Ÿ IP...');
                serverIP = await detectIP();
                console.log('åµæ¸¬åˆ°çš„ IP:', serverIP);
            }
            
            generateQR();
        }

        // å•Ÿå‹•
        window.addEventListener('load', init);
    </script>
</body>
</html>
