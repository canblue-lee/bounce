<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›¸æ©Ÿè¨ºæ–·å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: Arial, sans-serif;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .status-section {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            border-left: 5px solid #667eea;
        }

        .status-section h2 {
            color: #333;
            font-size: 18px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-label {
            color: #666;
            font-size: 14px;
        }

        .status-value {
            font-weight: bold;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
        }

        .status-value.success {
            background: #d4edda;
            color: #155724;
        }

        .status-value.error {
            background: #f8d7da;
            color: #721c24;
        }

        .status-value.warning {
            background: #fff3cd;
            color: #856404;
        }

        .status-value.info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .video-preview {
            width: 100%;
            border-radius: 15px;
            margin: 20px 0;
            background: #000;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        video {
            width: 100%;
            border-radius: 15px;
        }

        .btn {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin: 10px 0;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #721c24;
        }

        .error-message pre {
            margin-top: 10px;
            padding: 10px;
            background: rgba(0,0,0,0.1);
            border-radius: 5px;
            font-size: 12px;
            overflow-x: auto;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #155724;
            text-align: center;
            font-weight: bold;
        }

        .log-section {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-section h3 {
            color: #333;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .log-item {
            font-size: 12px;
            color: #666;
            padding: 5px 0;
            font-family: monospace;
        }

        .icon {
            font-size: 24px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ç›¸æ©Ÿè¨ºæ–·å·¥å…·</h1>

        <!-- ç€è¦½å™¨è³‡è¨Š -->
        <div class="status-section">
            <h2><span class="icon">ğŸ“±</span> è£ç½®è³‡è¨Š</h2>
            <div class="status-item">
                <span class="status-label">ç€è¦½å™¨</span>
                <span class="status-value info" id="browser">æª¢æ¸¬ä¸­...</span>
            </div>
            <div class="status-item">
                <span class="status-label">ä½œæ¥­ç³»çµ±</span>
                <span class="status-value info" id="os">æª¢æ¸¬ä¸­...</span>
            </div>
            <div class="status-item">
                <span class="status-label">é€£ç·šé¡å‹</span>
                <span class="status-value" id="protocol">æª¢æ¸¬ä¸­...</span>
            </div>
        </div>

        <!-- ç›¸æ©Ÿæ”¯æ´ç‹€æ…‹ -->
        <div class="status-section">
            <h2><span class="icon">ğŸ“¸</span> ç›¸æ©Ÿæ”¯æ´ç‹€æ…‹</h2>
            <div class="status-item">
                <span class="status-label">getUserMedia API</span>
                <span class="status-value" id="apiSupport">æª¢æ¸¬ä¸­...</span>
            </div>
            <div class="status-item">
                <span class="status-label">åª’é«”è£ç½®åˆ—èˆ‰</span>
                <span class="status-value" id="deviceEnum">æª¢æ¸¬ä¸­...</span>
            </div>
            <div class="status-item">
                <span class="status-label">åµæ¸¬åˆ°çš„ç›¸æ©Ÿ</span>
                <span class="status-value" id="cameraCount">æª¢æ¸¬ä¸­...</span>
            </div>
        </div>

        <!-- ç›¸æ©Ÿæ¬Šé™ç‹€æ…‹ -->
        <div class="status-section">
            <h2><span class="icon">ğŸ”</span> æ¬Šé™ç‹€æ…‹</h2>
            <div class="status-item">
                <span class="status-label">ç›¸æ©Ÿæ¬Šé™</span>
                <span class="status-value" id="permission">æª¢æ¸¬ä¸­...</span>
            </div>
        </div>

        <!-- éŒ¯èª¤è¨Šæ¯ -->
        <div id="errorContainer"></div>

        <!-- æˆåŠŸè¨Šæ¯ -->
        <div id="successContainer"></div>

        <!-- ç›¸æ©Ÿé è¦½ -->
        <div class="video-preview" id="videoContainer">
            <span style="opacity: 0.5;">ç›¸æ©Ÿé è¦½å€</span>
        </div>

        <!-- æ“ä½œæŒ‰éˆ• -->
        <button class="btn btn-primary" onclick="testCamera()">
            ğŸš€ æ¸¬è©¦å•Ÿå‹•ç›¸æ©Ÿ
        </button>

        <button class="btn btn-primary" onclick="requestPermission()">
            ğŸ”“ è«‹æ±‚ç›¸æ©Ÿæ¬Šé™
        </button>

        <button class="btn btn-primary" onclick="checkPermissionStatus()">
            ğŸ” æª¢æŸ¥æ¬Šé™ç‹€æ…‹
        </button>

        <!-- è¨ºæ–·æ—¥èªŒ -->
        <div class="log-section">
            <h3>ğŸ“‹ è¨ºæ–·æ—¥èªŒ</h3>
            <div id="logContainer"></div>
        </div>
    </div>

    <script>
        let logs = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('zh-TW');
            const logItem = `[${timestamp}] ${message}`;
            logs.push(logItem);
            
            const logContainer = document.getElementById('logContainer');
            const div = document.createElement('div');
            div.className = 'log-item';
            div.textContent = logItem;
            logContainer.appendChild(div);
            logContainer.scrollTop = logContainer.scrollHeight;

            console.log(message);
        }

        // åˆå§‹åŒ–æª¢æ¸¬
        async function init() {
            log('ğŸ” é–‹å§‹è¨ºæ–·...');

            // æª¢æ¸¬ç€è¦½å™¨
            const ua = navigator.userAgent;
            let browser = 'Unknown';
            if (ua.includes('Safari') && !ua.includes('Chrome')) browser = 'Safari';
            else if (ua.includes('Chrome')) browser = 'Chrome';
            else if (ua.includes('Firefox')) browser = 'Firefox';
            document.getElementById('browser').textContent = browser;
            document.getElementById('browser').className = 'status-value info';
            log(`ç€è¦½å™¨: ${browser}`);

            // æª¢æ¸¬ä½œæ¥­ç³»çµ±
            let os = 'Unknown';
            if (ua.includes('iPhone')) os = 'iOS (iPhone)';
            else if (ua.includes('iPad')) os = 'iOS (iPad)';
            else if (ua.includes('Android')) os = 'Android';
            else if (ua.includes('Mac')) os = 'macOS';
            else if (ua.includes('Windows')) os = 'Windows';
            document.getElementById('os').textContent = os;
            document.getElementById('os').className = 'status-value info';
            log(`ä½œæ¥­ç³»çµ±: ${os}`);

            // æª¢æ¸¬é€£ç·šé¡å‹
            const protocol = window.location.protocol;
            document.getElementById('protocol').textContent = protocol;
            document.getElementById('protocol').className = 
                protocol === 'https:' ? 'status-value success' : 'status-value warning';
            log(`é€£ç·šå”å®š: ${protocol}`);
            
            if (protocol !== 'https:') {
                log('âš ï¸ è­¦å‘Š: ä½¿ç”¨ HTTP é€£ç·š,æŸäº›ç€è¦½å™¨å¯èƒ½æœƒé™åˆ¶ç›¸æ©Ÿå­˜å–', 'warning');
            }

            // æª¢æ¸¬ API æ”¯æ´
            const hasGetUserMedia = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
            document.getElementById('apiSupport').textContent = hasGetUserMedia ? 'âœ… æ”¯æ´' : 'âŒ ä¸æ”¯æ´';
            document.getElementById('apiSupport').className = 
                hasGetUserMedia ? 'status-value success' : 'status-value error';
            log(`getUserMedia API: ${hasGetUserMedia ? 'æ”¯æ´' : 'ä¸æ”¯æ´'}`);

            // æª¢æ¸¬è£ç½®åˆ—èˆ‰
            const hasEnumerate = !!(navigator.mediaDevices && navigator.mediaDevices.enumerateDevices);
            document.getElementById('deviceEnum').textContent = hasEnumerate ? 'âœ… æ”¯æ´' : 'âŒ ä¸æ”¯æ´';
            document.getElementById('deviceEnum').className = 
                hasEnumerate ? 'status-value success' : 'status-value error';
            log(`enumerateDevices API: ${hasEnumerate ? 'æ”¯æ´' : 'ä¸æ”¯æ´'}`);

            // åˆ—èˆ‰ç›¸æ©Ÿè£ç½®
            if (hasEnumerate) {
                try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const cameras = devices.filter(d => d.kind === 'videoinput');
                    document.getElementById('cameraCount').textContent = `${cameras.length} å€‹`;
                    document.getElementById('cameraCount').className = 
                        cameras.length > 0 ? 'status-value success' : 'status-value error';
                    log(`åµæ¸¬åˆ° ${cameras.length} å€‹ç›¸æ©Ÿ`);
                    
                    cameras.forEach((camera, index) => {
                        log(`  ç›¸æ©Ÿ ${index + 1}: ${camera.label || 'æœªå‘½å'}`);
                    });
                } catch (error) {
                    log(`âŒ åˆ—èˆ‰è£ç½®å¤±æ•—: ${error.message}`, 'error');
                    document.getElementById('cameraCount').textContent = 'ç„¡æ³•åµæ¸¬';
                    document.getElementById('cameraCount').className = 'status-value error';
                }
            }

            // æª¢æŸ¥æ¬Šé™
            await checkPermissionStatus();

            log('âœ… è¨ºæ–·å®Œæˆ');
        }

        // æª¢æŸ¥æ¬Šé™ç‹€æ…‹
        async function checkPermissionStatus() {
            log('ğŸ” æª¢æŸ¥æ¬Šé™ç‹€æ…‹...');
            
            try {
                if (navigator.permissions && navigator.permissions.query) {
                    const result = await navigator.permissions.query({ name: 'camera' });
                    document.getElementById('permission').textContent = result.state;
                    
                    if (result.state === 'granted') {
                        document.getElementById('permission').className = 'status-value success';
                        log('âœ… ç›¸æ©Ÿæ¬Šé™: å·²æˆäºˆ');
                    } else if (result.state === 'denied') {
                        document.getElementById('permission').className = 'status-value error';
                        log('âŒ ç›¸æ©Ÿæ¬Šé™: å·²æ‹’çµ•');
                    } else {
                        document.getElementById('permission').className = 'status-value warning';
                        log('âš ï¸ ç›¸æ©Ÿæ¬Šé™: å¾…è©¢å•');
                    }
                } else {
                    document.getElementById('permission').textContent = 'ç„¡æ³•æª¢æ¸¬';
                    document.getElementById('permission').className = 'status-value warning';
                    log('âš ï¸ ç€è¦½å™¨ä¸æ”¯æ´ Permissions API');
                }
            } catch (error) {
                log(`âŒ æª¢æŸ¥æ¬Šé™å¤±æ•—: ${error.message}`, 'error');
                document.getElementById('permission').textContent = 'æª¢æŸ¥å¤±æ•—';
                document.getElementById('permission').className = 'status-value error';
            }
        }

        // è«‹æ±‚æ¬Šé™
        async function requestPermission() {
            log('ğŸ”“ è«‹æ±‚ç›¸æ©Ÿæ¬Šé™...');
            
            document.getElementById('errorContainer').innerHTML = '';
            document.getElementById('successContainer').innerHTML = '';

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                
                log('âœ… æ¬Šé™è«‹æ±‚æˆåŠŸ!');
                
                // ç«‹å³åœæ­¢ä¸²æµ
                stream.getTracks().forEach(track => track.stop());
                
                const successDiv = document.createElement('div');
                successDiv.className = 'success-message';
                successDiv.textContent = 'âœ… ç›¸æ©Ÿæ¬Šé™å·²æˆäºˆ!å¯ä»¥ä½¿ç”¨ç›¸æ©Ÿäº†ã€‚';
                document.getElementById('successContainer').appendChild(successDiv);

                // é‡æ–°æª¢æŸ¥ç‹€æ…‹
                await checkPermissionStatus();
                
            } catch (error) {
                log(`âŒ æ¬Šé™è«‹æ±‚å¤±æ•—: ${error.name} - ${error.message}`, 'error');
                
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.innerHTML = `
                    <strong>âŒ ç„¡æ³•å–å¾—ç›¸æ©Ÿæ¬Šé™</strong>
                    <p>éŒ¯èª¤: ${error.name}</p>
                    <pre>${error.message}</pre>
                `;
                document.getElementById('errorContainer').appendChild(errorDiv);

                if (error.name === 'NotAllowedError') {
                    log('ğŸ’¡ æç¤º: è«‹åˆ° Safari è¨­å®šä¸­å…è¨±ç›¸æ©Ÿæ¬Šé™', 'info');
                } else if (error.name === 'NotFoundError') {
                    log('ğŸ’¡ æç¤º: æ‰¾ä¸åˆ°ç›¸æ©Ÿè£ç½®', 'info');
                }
            }
        }

        // æ¸¬è©¦å•Ÿå‹•ç›¸æ©Ÿ
        async function testCamera() {
            log('ğŸš€ å˜—è©¦å•Ÿå‹•ç›¸æ©Ÿ...');
            
            document.getElementById('errorContainer').innerHTML = '';
            document.getElementById('successContainer').innerHTML = '';

            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                });

                log('âœ… ç›¸æ©Ÿå•Ÿå‹•æˆåŠŸ!');

                // é¡¯ç¤ºé è¦½
                const video = document.createElement('video');
                video.autoplay = true;
                video.playsInline = true;
                video.srcObject = stream;

                const container = document.getElementById('videoContainer');
                container.innerHTML = '';
                container.appendChild(video);

                const successDiv = document.createElement('div');
                successDiv.className = 'success-message';
                successDiv.textContent = 'ğŸ‰ ç›¸æ©Ÿé‹ä½œæ­£å¸¸!å·²é¡¯ç¤ºé è¦½ç•«é¢ã€‚';
                document.getElementById('successContainer').appendChild(successDiv);

                log('ğŸ“¹ ç›¸æ©Ÿé è¦½å·²å•Ÿå‹•');
                log(`è§£æåº¦: ${stream.getVideoTracks()[0].getSettings().width}x${stream.getVideoTracks()[0].getSettings().height}`);

            } catch (error) {
                log(`âŒ ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—: ${error.name} - ${error.message}`, 'error');

                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                
                let suggestion = '';
                if (error.name === 'NotAllowedError') {
                    suggestion = `
                        <p><strong>ğŸ”§ è§£æ±ºæ–¹æ³•:</strong></p>
                        <ol style="margin: 10px 0; padding-left: 20px;">
                            <li>å‰å¾€ iPhoneã€Œè¨­å®šã€</li>
                            <li>æ‰¾åˆ°ã€ŒSafariã€</li>
                            <li>é»é¸ã€Œç›¸æ©Ÿã€</li>
                            <li>é¸æ“‡ã€Œå…è¨±ã€</li>
                            <li>é‡æ–°è¼‰å…¥æ­¤é é¢</li>
                        </ol>
                    `;
                } else if (error.name === 'NotFoundError') {
                    suggestion = '<p><strong>ğŸ’¡ æç¤º:</strong> æ‰¾ä¸åˆ°ç›¸æ©Ÿè£ç½®,è«‹ç¢ºèªç›¸æ©ŸåŠŸèƒ½æ­£å¸¸ã€‚</p>';
                } else if (error.name === 'NotReadableError') {
                    suggestion = '<p><strong>ğŸ’¡ æç¤º:</strong> ç›¸æ©Ÿå¯èƒ½è¢«å…¶ä»– App ä½”ç”¨,è«‹é—œé–‰å…¶ä»–ä½¿ç”¨ç›¸æ©Ÿçš„ Appã€‚</p>';
                }

                errorDiv.innerHTML = `
                    <strong>âŒ ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—</strong>
                    <p>éŒ¯èª¤é¡å‹: ${error.name}</p>
                    <pre>${error.message}</pre>
                    ${suggestion}
                `;
                document.getElementById('errorContainer').appendChild(errorDiv);
            }
        }

        // å•Ÿå‹•
        window.addEventListener('load', init);
    </script>
</body>
</html>
