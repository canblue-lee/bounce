<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›¸æ©Ÿæƒæ - ç‰©é«”åµæ¸¬</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            overflow: hidden;
            background: #000;
            font-family: Arial, sans-serif;
            touch-action: none;
            user-select: none;
        }

        /* ç›¸æ©Ÿé è¦½ */
        #videoElement {
            position: absolute;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
        }

        /* è™•ç†ç”¨çš„éš±è— canvas */
        #hiddenCanvas {
            display: none;
        }

        /* æƒæè¦†è“‹å±¤ */
        .scan-overlay {
            position: absolute;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 10;
        }

        /* æƒææ¡† */
        .scan-frame {
            position: absolute;
            top: 10%;
            left: 10%;
            width: 80%;
            height: 70%;
            border: 3px solid #00ff88;
            border-radius: 20px;
            box-shadow: 
                inset 0 0 30px rgba(0, 255, 136, 0.3),
                0 0 30px rgba(0, 255, 136, 0.5);
        }

        /* å››å€‹è§’çš„æ¨™è¨˜ */
        .corner {
            position: absolute;
            width: 30px;
            height: 30px;
            border: 4px solid #00ff88;
        }

        .corner.top-left {
            top: -4px;
            left: -4px;
            border-right: none;
            border-bottom: none;
        }

        .corner.top-right {
            top: -4px;
            right: -4px;
            border-left: none;
            border-bottom: none;
        }

        .corner.bottom-left {
            bottom: -4px;
            left: -4px;
            border-right: none;
            border-top: none;
        }

        .corner.bottom-right {
            bottom: -4px;
            right: -4px;
            border-left: none;
            border-top: none;
        }

        /* æƒæç·šå‹•ç•« */
        .scan-line {
            position: absolute;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, 
                transparent,
                #00ff88,
                transparent
            );
            box-shadow: 0 0 20px #00ff88;
            animation: scanVertical 2s ease-in-out infinite;
        }

        @keyframes scanVertical {
            0%, 100% { top: 0; }
            50% { top: 100%; }
        }

        /* åµæ¸¬åˆ°çš„ç‰©é«”æ¨™è¨˜ */
        .detected-object {
            position: absolute;
            border: 3px solid #ff00ff;
            border-radius: 10px;
            background: rgba(255, 0, 255, 0.2);
            box-shadow: 
                inset 0 0 20px rgba(255, 0, 255, 0.3),
                0 0 20px rgba(255, 0, 255, 0.5);
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.8; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }

        .object-label {
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 0, 255, 0.9);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            white-space: nowrap;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.5);
        }

        /* é ‚éƒ¨ UI */
        .top-ui {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 20px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            z-index: 20;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            margin-bottom: 15px;
        }

        .status-text {
            font-size: 18px;
            font-weight: bold;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #00ff88;
            box-shadow: 0 0 15px #00ff88;
            animation: blink 1.5s ease-in-out infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .instruction {
            background: rgba(0, 0, 0, 0.7);
            padding: 15px 20px;
            border-radius: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .instruction h2 {
            color: #00ff88;
            font-size: 20px;
            margin-bottom: 8px;
        }

        .instruction p {
            color: white;
            font-size: 14px;
            opacity: 0.9;
        }

        /* é€²åº¦å€åŸŸ */
        .progress-section {
            position: absolute;
            left: 20px;
            right: 20px;
            bottom: 150px;
            z-index: 20;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #00d4ff);
            width: 0%;
            transition: width 0.5s ease;
            box-shadow: 0 0 15px #00ff88;
        }

        .progress-text {
            color: white;
            text-align: center;
            margin-top: 10px;
            font-size: 16px;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.8);
        }

        /* åµæ¸¬çµ±è¨ˆ */
        .detection-stats {
            position: absolute;
            right: 20px;
            top: 150px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            z-index: 20;
            min-width: 150px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 8px 0;
            color: white;
            font-size: 14px;
        }

        .stat-value {
            color: #00ff88;
            font-weight: bold;
            font-size: 18px;
        }

        /* åº•éƒ¨æ§åˆ¶ */
        .bottom-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            z-index: 20;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .btn {
            padding: 18px 30px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
            transition: all 0.3s;
            pointer-events: all;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-primary {
            background: linear-gradient(135deg, #00ff88, #00d4ff);
            color: #000;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            backdrop-filter: blur(10px);
        }

        .btn.hidden {
            display: none;
        }

        .btn.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        /* æç¤ºè¨Šæ¯ */
        .toast {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 30px 40px;
            border-radius: 20px;
            font-size: 18px;
            z-index: 100;
            opacity: 0;
            transition: all 0.3s;
            pointer-events: none;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .toast.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        .toast-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        /* å¼•å°æ‰‹å‹¢ */
        .gesture-guide {
            position: absolute;
            left: 20%;
            top: 50%;
            transform: translateY(-50%);
            font-size: 60px;
            animation: swipeGuide 3s ease-in-out infinite;
            pointer-events: none;
            z-index: 15;
        }

        @keyframes swipeGuide {
            0%, 100% {
                left: 20%;
                opacity: 0.7;
            }
            50% {
                left: 70%;
                opacity: 1;
            }
        }

        .gesture-guide.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- ç›¸æ©Ÿé è¦½ -->
    <video id="videoElement" autoplay playsinline></video>

    <!-- éš±è—è™•ç† canvas -->
    <canvas id="hiddenCanvas"></canvas>

    <!-- æƒæè¦†è“‹å±¤ -->
    <div class="scan-overlay">
        <div class="scan-frame">
            <div class="corner top-left"></div>
            <div class="corner top-right"></div>
            <div class="corner bottom-left"></div>
            <div class="corner bottom-right"></div>
            <div class="scan-line"></div>
        </div>
    </div>

    <!-- æ‰‹å‹¢å¼•å° -->
    <div class="gesture-guide" id="gestureGuide">
        ğŸ‘‰
    </div>

    <!-- é ‚éƒ¨ UI -->
    <div class="top-ui">
        <div class="status-bar">
            <div class="status-text" id="statusText">æº–å‚™æƒæ</div>
            <div class="status-indicator">
                <div class="status-dot"></div>
                <span style="color: white; font-size: 14px;">åµæ¸¬ä¸­</span>
            </div>
        </div>

        <div class="instruction" id="instruction">
            <h2>ğŸ“¸ ç›¸æ©Ÿæƒææ¨¡å¼</h2>
            <p>å°‡ç›¸æ©Ÿå°æº–ç‰†é¢,å¾å·¦ç·©æ…¢ç§»å‹•åˆ°å³</p>
        </div>
    </div>

    <!-- åµæ¸¬çµ±è¨ˆ -->
    <div class="detection-stats">
        <div class="stat-item">
            <span>å·²åµæ¸¬:</span>
            <span class="stat-value" id="detectionCount">0</span>
        </div>
        <div class="stat-item">
            <span>æƒæç¯„åœ:</span>
            <span class="stat-value" id="scanRange">0%</span>
        </div>
    </div>

    <!-- é€²åº¦å€åŸŸ -->
    <div class="progress-section">
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-text" id="progressText">ç­‰å¾…é–‹å§‹...</div>
    </div>

    <!-- åº•éƒ¨æ§åˆ¶ -->
    <div class="bottom-controls">
        <div class="btn-group">
            <button class="btn btn-primary" id="startBtn" onclick="startScanning()">
                ğŸš€ é–‹å§‹æƒæ
            </button>
            <button class="btn btn-secondary hidden" id="captureBtn" onclick="captureFrame()">
                ğŸ“¸ æ•æ‰
            </button>
            <button class="btn btn-secondary hidden" id="retryBtn" onclick="retry()">
                ğŸ”„ é‡æ–°æƒæ
            </button>
            <button class="btn btn-primary hidden" id="completeBtn" onclick="complete()">
                âœ… å®Œæˆ
            </button>
        </div>
    </div>

    <!-- åµæ¸¬åˆ°çš„ç‰©é«”å®¹å™¨ -->
    <div id="detectedObjects"></div>

    <!-- æç¤ºè¨Šæ¯ -->
    <div class="toast" id="toast">
        <div class="toast-icon" id="toastIcon">âœ¨</div>
        <div id="toastMessage">è¨Šæ¯</div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let video, canvas, ctx;
        let isScanning = false;
        let detectedObjects = [];
        let scanProgress = 0;
        let frameCount = 0;
        let lastCaptureTime = 0;

        // åˆå§‹åŒ–
        async function init() {
            console.log('ğŸ¥ ç›¸æ©Ÿæƒæç³»çµ±å•Ÿå‹•');

            video = document.getElementById('videoElement');
            canvas = document.getElementById('hiddenCanvas');
            ctx = canvas.getContext('2d');

            // å•Ÿå‹•ç›¸æ©Ÿ
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                });

                video.srcObject = stream;
                console.log('âœ… ç›¸æ©Ÿå•Ÿå‹•æˆåŠŸ');

                // ç­‰å¾…è¦–è¨Šè¼‰å…¥
                video.addEventListener('loadedmetadata', () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    console.log(`ğŸ“ è§£æåº¦: ${canvas.width}x${canvas.height}`);
                });

            } catch (error) {
                console.error('âŒ ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—:', error);
                showToast('âŒ', 'ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ\nè«‹ç¢ºèªå·²å…è¨±ç›¸æ©Ÿæ¬Šé™');
            }
        }

        // é–‹å§‹æƒæ
        function startScanning() {
            console.log('ğŸš€ é–‹å§‹æƒæ');
            isScanning = true;
            scanProgress = 0;
            frameCount = 0;

            // æ›´æ–° UI
            document.getElementById('startBtn').classList.add('hidden');
            document.getElementById('captureBtn').classList.remove('hidden');
            document.getElementById('retryBtn').classList.remove('hidden');

            document.getElementById('statusText').textContent = 'æƒæä¸­...';
            document.getElementById('instruction').innerHTML = `
                <h2>ğŸ‘‰ ç·©æ…¢å¾å·¦ç§»åˆ°å³</h2>
                <p>ä¿æŒæ‰‹æ©Ÿç©©å®š,è®“ç›¸æ©Ÿæ•æ‰æ•´å€‹ç‰†é¢</p>
            `;

            document.getElementById('gestureGuide').classList.remove('hidden');

            // é–‹å§‹è‡ªå‹•åµæ¸¬
            startAutoDetection();
        }

        // è‡ªå‹•åµæ¸¬å¾ªç’°
        function startAutoDetection() {
            const detectionInterval = setInterval(() => {
                if (!isScanning) {
                    clearInterval(detectionInterval);
                    return;
                }

                frameCount++;
                const now = Date.now();

                // æ¯ 500ms è‡ªå‹•æ•æ‰ä¸€æ¬¡
                if (now - lastCaptureTime > 500) {
                    captureFrame();
                    lastCaptureTime = now;
                }

                // æ›´æ–°é€²åº¦
                scanProgress = Math.min(frameCount * 2, 100);
                updateProgress(scanProgress);

                // å®Œæˆ
                if (scanProgress >= 100) {
                    clearInterval(detectionInterval);
                    finishScanning();
                }
            }, 100);
        }

        // æ•æ‰ç•«é¢
        function captureFrame() {
            if (!video.videoWidth) return;

            // ç¹ªè£½ç•¶å‰ç•«é¢åˆ° canvas
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // æ¨¡æ“¬é‚Šç·£åµæ¸¬ (çœŸå¯¦ç‰ˆæœ¬æœƒä½¿ç”¨ OpenCV.js)
            detectObjects();
        }

        // åµæ¸¬ç‰©é«” (ç°¡åŒ–ç‰ˆ)
        function detectObjects() {
            // æ¨¡æ“¬åµæ¸¬çµæœ
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            // éš¨æ©Ÿåµæ¸¬ç‰©é«” (çœŸå¯¦ç‰ˆæœ¬æœƒåˆ†æé‚Šç·£å’Œæ·±åº¦)
            if (Math.random() > 0.7 && detectedObjects.length < 4) {
                const randomX = Math.random() * 60 + 20;
                const randomY = Math.random() * 50 + 20;
                const randomW = Math.random() * 15 + 15;
                const randomH = Math.random() * 20 + 15;

                // æª¢æŸ¥æ˜¯å¦é‡è¤‡
                const isDuplicate = detectedObjects.some(obj => 
                    Math.abs(obj.x - randomX) < 10 && 
                    Math.abs(obj.y - randomY) < 10
                );

                if (!isDuplicate) {
                    const objTypes = ['æ›¸æ«ƒ', 'ç›¸æ¡†', 'æ¡Œå­', 'æ«ƒå­', 'è£é£¾å“'];
                    const objType = objTypes[detectedObjects.length % objTypes.length];

                    const newObj = {
                        x: randomX,
                        y: randomY,
                        width: randomW,
                        height: randomH,
                        name: objType,
                        confidence: 0.7 + Math.random() * 0.3
                    };

                    addDetectedObject(newObj);
                }
            }
        }

        // æ·»åŠ åµæ¸¬åˆ°çš„ç‰©é«”
        function addDetectedObject(obj) {
            detectedObjects.push(obj);

            // å‰µå»ºè¦–è¦ºæ¨™è¨˜
            const marker = document.createElement('div');
            marker.className = 'detected-object';
            marker.style.left = obj.x + '%';
            marker.style.top = obj.y + '%';
            marker.style.width = obj.width + '%';
            marker.style.height = obj.height + '%';

            const label = document.createElement('div');
            label.className = 'object-label';
            label.textContent = `${obj.name} ${Math.round(obj.confidence * 100)}%`;
            marker.appendChild(label);

            document.getElementById('detectedObjects').appendChild(marker);

            // æ›´æ–°çµ±è¨ˆ
            document.getElementById('detectionCount').textContent = detectedObjects.length;

            console.log('ğŸ¯ åµæ¸¬åˆ°:', obj.name, 'ä¿¡å¿ƒåº¦:', Math.round(obj.confidence * 100) + '%');

            // è§¸è¦ºå›é¥‹
            if (navigator.vibrate) {
                navigator.vibrate(100);
            }
        }

        // æ›´æ–°é€²åº¦
        function updateProgress(progress) {
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('scanRange').textContent = Math.round(progress) + '%';
            document.getElementById('progressText').textContent = 
                `æƒæé€²åº¦: ${Math.round(progress)}% | å·²åµæ¸¬ ${detectedObjects.length} å€‹ç‰©é«”`;
        }

        // å®Œæˆæƒæ
        function finishScanning() {
            console.log('âœ… æƒæå®Œæˆ');
            isScanning = false;

            document.getElementById('gestureGuide').classList.add('hidden');
            document.getElementById('statusText').textContent = 'æƒæå®Œæˆ!';
            document.getElementById('instruction').innerHTML = `
                <h2>âœ¨ æƒæå®Œæˆ!</h2>
                <p>å·²åµæ¸¬åˆ° ${detectedObjects.length} å€‹éšœç¤™ç‰©</p>
            `;

            document.getElementById('captureBtn').classList.add('hidden');
            document.getElementById('completeBtn').classList.remove('hidden');

            showToast('âœ…', `æƒæå®Œæˆ!\nå·²åµæ¸¬åˆ° ${detectedObjects.length} å€‹ç‰©é«”`);
        }

        // é‡æ–°æƒæ
        function retry() {
            console.log('ğŸ”„ é‡æ–°æƒæ');
            
            detectedObjects = [];
            scanProgress = 0;
            frameCount = 0;

            document.getElementById('detectedObjects').innerHTML = '';
            document.getElementById('detectionCount').textContent = '0';
            updateProgress(0);

            document.getElementById('startBtn').classList.remove('hidden');
            document.getElementById('captureBtn').classList.add('hidden');
            document.getElementById('retryBtn').classList.add('hidden');
            document.getElementById('completeBtn').classList.add('hidden');
            document.getElementById('gestureGuide').classList.add('hidden');

            document.getElementById('statusText').textContent = 'æº–å‚™æƒæ';
            document.getElementById('instruction').innerHTML = `
                <h2>ğŸ“¸ ç›¸æ©Ÿæƒææ¨¡å¼</h2>
                <p>å°‡ç›¸æ©Ÿå°æº–ç‰†é¢,å¾å·¦ç·©æ…¢ç§»å‹•åˆ°å³</p>
            `;
        }

        // å®Œæˆ
        function complete() {
            console.log('ğŸ’¾ å„²å­˜è¨­å®š:', detectedObjects);

            if (detectedObjects.length === 0) {
                showToast('âš ï¸', 'æœªåµæ¸¬åˆ°ä»»ä½•ç‰©é«”\nè«‹é‡æ–°æƒæ');
                return;
            }

            // å„²å­˜
            localStorage.setItem('scannedObjects', JSON.stringify(detectedObjects));

            // å‚³é€åˆ°éŠæˆ²ç³»çµ±
            const data = {
                type: 'SPACE_SCAN',
                objects: detectedObjects,
                timestamp: Date.now()
            };

            if (window.opener) {
                window.opener.postMessage(data, '*');
            }

            showToast('âœ…', 'è¨­å®šå®Œæˆ!\nå³å°‡è¿”å›éŠæˆ²...', () => {
                setTimeout(() => {
                    window.location.href = '/game-ws.html?mode=display';
                }, 2000);
            });
        }

        // é¡¯ç¤ºæç¤º
        function showToast(icon, message, callback) {
            const toast = document.getElementById('toast');
            document.getElementById('toastIcon').textContent = icon;
            document.getElementById('toastMessage').textContent = message;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
                if (callback) callback();
            }, 2500);
        }

        // å•Ÿå‹•
        window.addEventListener('load', init);
    </script>
</body>
</html>
