<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰‹æ©Ÿæ ¡æ­£ - æ‹æ”æ¨¡å¼</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            overflow: hidden;
            background: #000;
            font-family: Arial, sans-serif;
            touch-action: none;
        }

        /* ç›¸æ©Ÿé è¦½ */
        #video {
            position: absolute;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
        }

        /* Canvas è¦†è“‹å±¤ */
        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 10;
        }

        /* UI è¦†è“‹å±¤ */
        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 20;
            pointer-events: none;
        }

        /* é ‚éƒ¨ç‹€æ…‹ */
        .top-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 20px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
            pointer-events: all;
        }

        .status {
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 20px;
            border-radius: 15px;
            color: white;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .status h2 {
            color: #00ff88;
            font-size: 20px;
            margin-bottom: 8px;
        }

        .status p {
            font-size: 14px;
            opacity: 0.9;
        }

        /* ç•¶å‰é»æŒ‡ç¤º */
        .current-point {
            position: absolute;
            top: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 255, 136, 0.95);
            color: #000;
            padding: 20px 40px;
            border-radius: 50px;
            font-size: 24px;
            font-weight: bold;
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.5);
            animation: bounce 1s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-10px); }
        }

        /* å·²æ¨™è¨˜çš„é» */
        .marked-point {
            position: absolute;
            width: 40px;
            height: 40px;
            border: 4px solid #00ff88;
            border-radius: 50%;
            background: rgba(0, 255, 136, 0.3);
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #00ff88;
            font-weight: bold;
            font-size: 18px;
            box-shadow: 0 0 20px #00ff88;
            animation: ping 1.5s ease-in-out infinite;
        }

        @keyframes ping {
            0%, 100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 0.5; transform: translate(-50%, -50%) scale(1.2); }
        }

        /* é€²åº¦æ¢ */
        .progress-bar {
            position: absolute;
            bottom: 200px;
            left: 20px;
            right: 20px;
            height: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #00d4ff);
            transition: width 0.3s;
            box-shadow: 0 0 20px #00ff88;
        }

        /* åº•éƒ¨æ§åˆ¶ */
        .bottom-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            pointer-events: all;
        }

        .instruction-text {
            color: white;
            text-align: center;
            margin-bottom: 20px;
            font-size: 16px;
            line-height: 1.5;
        }

        .btn {
            width: 100%;
            padding: 18px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            margin: 10px 0;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00ff88, #00d4ff);
            color: #000;
        }

        .btn:active {
            transform: scale(0.98);
        }

        /* æˆåŠŸç•«é¢ */
        .success-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .success-content {
            text-align: center;
            color: white;
        }

        .success-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: bounceIn 0.5s;
        }

        @keyframes bounceIn {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <!-- ç›¸æ©Ÿé è¦½ -->
    <video id="video" autoplay playsinline></video>

    <!-- Canvas -->
    <canvas id="canvas"></canvas>

    <!-- UI è¦†è“‹å±¤ -->
    <div class="ui-overlay">
        <!-- é ‚éƒ¨ç‹€æ…‹ -->
        <div class="top-bar">
            <div class="status">
                <h2>ğŸ“¸ æ ¡æ­£æ‹æ”æ¨¡å¼</h2>
                <p>é»æ“Šç•«é¢æ¨™è¨˜æŠ•å½±çš„ç¶ è‰²åœ“é»</p>
            </div>
        </div>

        <!-- ç•¶å‰é» -->
        <div class="current-point" id="currentPoint">
            è«‹æ¨™è¨˜: é» 1 (å·¦ä¸Š)
        </div>

        <!-- å·²æ¨™è¨˜çš„é»å®¹å™¨ -->
        <div id="markedPoints"></div>

        <!-- é€²åº¦æ¢ -->
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
    </div>

    <!-- åº•éƒ¨æ§åˆ¶ -->
    <div class="bottom-controls">
        <div class="instruction-text" id="instructionText">
            ğŸ‘† é»æ“Šç•«é¢ä¸­çš„ç¶ è‰²åœ“é»ä½ç½®
        </div>
        <button class="btn btn-primary" id="resetBtn" onclick="resetCalibration()">
            ğŸ”„ é‡æ–°æ¨™è¨˜
        </button>
    </div>

    <!-- æˆåŠŸç•«é¢ -->
    <div class="success-screen" id="successScreen">
        <div class="success-content">
            <div class="success-icon">âœ…</div>
            <h1>æ ¡æ­£å®Œæˆ!</h1>
            <p>è®Šæ›çŸ©é™£å·²è¨ˆç®—ä¸¦å„²å­˜</p>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let video, canvas, ctx;
        let capturedPoints = [];
        let sessionId = null;
        
        const pointNames = [
            'é» 1 (å·¦ä¸Š)',
            'é» 2 (å³ä¸Š)',
            'é» 3 (å·¦ä¸‹)',
            'é» 4 (å³ä¸‹)'
        ];

        // åˆå§‹åŒ–
        async function init() {
            console.log('ğŸ“¸ æ‰‹æ©Ÿæ ¡æ­£æ¨¡å¼å•Ÿå‹•');

            // å–å¾— Session ID
            const urlParams = new URLSearchParams(window.location.search);
            sessionId = urlParams.get('session');
            
            if (!sessionId) {
                alert('éŒ¯èª¤: æ‰¾ä¸åˆ°æ ¡æ­£ Session ID');
                return;
            }

            console.log('Session ID:', sessionId);

            video = document.getElementById('video');
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');

            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            // å•Ÿå‹•ç›¸æ©Ÿ
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                });

                video.srcObject = stream;
                console.log('âœ… ç›¸æ©Ÿå•Ÿå‹•æˆåŠŸ');

            } catch (error) {
                console.error('âŒ ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—:', error);
                alert('ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ,è«‹æª¢æŸ¥æ¬Šé™');
            }
        }

        // é»æ“Šæ¨™è¨˜é»
        canvas.addEventListener('click', (e) => {
            if (capturedPoints.length >= 4) return;

            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            // å„²å­˜é»
            capturedPoints.push({
                x: x,
                y: y,
                screenX: (x / canvas.width) * 100,
                screenY: (y / canvas.height) * 100
            });

            console.log(`âœ… æ¨™è¨˜é» ${capturedPoints.length}:`, { x, y });

            // é¡¯ç¤ºæ¨™è¨˜
            addMarker(x, y, capturedPoints.length);

            // æ›´æ–°é€²åº¦
            updateProgress();

            // æª¢æŸ¥æ˜¯å¦å®Œæˆ
            if (capturedPoints.length === 4) {
                completeCalibration();
            } else {
                updateInstruction();
            }
        });

        // æ·»åŠ æ¨™è¨˜
        function addMarker(x, y, number) {
            const marker = document.createElement('div');
            marker.className = 'marked-point';
            marker.style.left = x + 'px';
            marker.style.top = y + 'px';
            marker.textContent = number;
            document.getElementById('markedPoints').appendChild(marker);
        }

        // æ›´æ–°é€²åº¦
        function updateProgress() {
            const progress = (capturedPoints.length / 4) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        // æ›´æ–°æŒ‡ç¤º
        function updateInstruction() {
            const nextIndex = capturedPoints.length;
            document.getElementById('currentPoint').textContent = 
                `è«‹æ¨™è¨˜: ${pointNames[nextIndex]}`;
        }

        // å®Œæˆæ ¡æ­£
        function completeCalibration() {
            console.log('ğŸ‰ æ ¡æ­£å®Œæˆ!');

            // å–å¾—æŠ•å½±é¡¯ç¤ºçš„é»åº§æ¨™
            const displayData = JSON.parse(localStorage.getItem('calibrationDisplayPoints'));
            
            if (!displayData || displayData.sessionId !== sessionId) {
                alert('éŒ¯èª¤: æ‰¾ä¸åˆ°æŠ•å½±é¡¯ç¤ºåº§æ¨™');
                return;
            }

            // çµ„åˆæ ¡æ­£è³‡æ–™
            const calibrationData = {
                sessionId: sessionId,
                timestamp: Date.now(),
                displayPoints: displayData.displayPoints,
                capturedPoints: {
                    point1: capturedPoints[0],
                    point2: capturedPoints[1],
                    point3: capturedPoints[2],
                    point4: capturedPoints[3]
                },
                screenSize: {
                    width: canvas.width,
                    height: canvas.height
                }
            };

            // è¨ˆç®—è®Šæ›çŸ©é™£
            const matrix = calculateTransformMatrix(calibrationData);
            calibrationData.transformMatrix = matrix;

            // å„²å­˜
            localStorage.setItem('calibrationData', JSON.stringify(calibrationData));
            localStorage.setItem(`calibrationResult_${sessionId}`, JSON.stringify(calibrationData));

            console.log('âœ… æ ¡æ­£è³‡æ–™å·²å„²å­˜:', calibrationData);

            // é¡¯ç¤ºå®Œæˆç•«é¢
            document.getElementById('successScreen').style.display = 'flex';

            // 3 ç§’å¾Œè·³è½‰åˆ°æƒæé é¢
            setTimeout(() => {
                window.location.href = '/space-scan-ai.html';
            }, 3000);
        }

        // è¨ˆç®—è®Šæ›çŸ©é™£ (ç°¡åŒ–ç‰ˆ)
        function calculateTransformMatrix(data) {
            // é€™è£¡ä½¿ç”¨ç°¡åŒ–çš„ç·šæ€§è®Šæ›
            // å°ˆæ¥­ç‰ˆæ‡‰è©²ä½¿ç”¨ OpenCV çš„ getPerspectiveTransform
            
            const src = [
                [data.capturedPoints.point1.x, data.capturedPoints.point1.y],
                [data.capturedPoints.point2.x, data.capturedPoints.point2.y],
                [data.capturedPoints.point3.x, data.capturedPoints.point3.y],
                [data.capturedPoints.point4.x, data.capturedPoints.point4.y]
            ];

            const dst = [
                [data.displayPoints.point1.x, data.displayPoints.point1.y],
                [data.displayPoints.point2.x, data.displayPoints.point2.y],
                [data.displayPoints.point3.x, data.displayPoints.point3.y],
                [data.displayPoints.point4.x, data.displayPoints.point4.y]
            ];

            // ç°¡åŒ–çš„è®Šæ›çŸ©é™£ (å¯¦éš›æ‡‰è©²ç”¨ perspective transform)
            return {
                type: 'perspective',
                srcPoints: src,
                dstPoints: dst,
                scaleX: (dst[1][0] - dst[0][0]) / (src[1][0] - src[0][0]),
                scaleY: (dst[2][1] - dst[0][1]) / (src[2][1] - src[0][1]),
                offsetX: dst[0][0] - src[0][0],
                offsetY: dst[0][1] - src[0][1]
            };
        }

        // é‡ç½®
        function resetCalibration() {
            capturedPoints = [];
            document.getElementById('markedPoints').innerHTML = '';
            updateProgress();
            updateInstruction();
        }

        // å•Ÿå‹•
        window.addEventListener('load', init);
    </script>
</body>
</html>
