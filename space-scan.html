<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç©ºé–“æƒæ - è¨­å®šçœŸå¯¦éšœç¤™ç‰©</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            overflow: hidden;
            background: #000;
            font-family: Arial, sans-serif;
            touch-action: none;
            user-select: none;
        }

        /* ç›¸æ©Ÿé è¦½ */
        #camera {
            position: absolute;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
        }

        /* é®ç½©å±¤ */
        .overlay {
            position: absolute;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10;
        }

        /* å¼•å°å‹•ç•«å®¹å™¨ */
        .guide-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 20;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }

        /* æƒææŒ‡ç¤ºç·š */
        .scan-line {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 100%;
            background: linear-gradient(to bottom, 
                transparent 0%,
                #00ff88 20%,
                #00ff88 80%,
                transparent 100%
            );
            box-shadow: 0 0 20px #00ff88;
            animation: scanMove 3s ease-in-out infinite;
            opacity: 0;
        }

        .scan-line.active {
            opacity: 1;
        }

        @keyframes scanMove {
            0%, 100% { left: 10%; }
            50% { left: 90%; }
        }

        /* æƒææ¡† */
        .scan-frame {
            position: absolute;
            width: 90%;
            height: 70%;
            border: 3px solid #00ff88;
            border-radius: 20px;
            box-shadow: 
                inset 0 0 30px rgba(0, 255, 136, 0.3),
                0 0 30px rgba(0, 255, 136, 0.5);
        }

        .scan-frame::before,
        .scan-frame::after {
            content: '';
            position: absolute;
            width: 30px;
            height: 30px;
            border: 4px solid #00ff88;
        }

        .scan-frame::before {
            top: -4px;
            left: -4px;
            border-right: none;
            border-bottom: none;
        }

        .scan-frame::after {
            bottom: -4px;
            right: -4px;
            border-left: none;
            border-top: none;
        }

        /* æç¤ºæ–‡å­— */
        .instruction {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 20px 30px;
            border-radius: 15px;
            color: white;
            font-size: 18px;
            text-align: center;
            max-width: 90%;
            backdrop-filter: blur(10px);
            z-index: 30;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
        }

        .instruction h2 {
            color: #00ff88;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .instruction .step {
            font-size: 16px;
            opacity: 0.9;
            margin: 5px 0;
        }

        /* é€²åº¦æ¢ */
        .progress-container {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            z-index: 30;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #00d4ff);
            width: 0%;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px #00ff88;
        }

        .progress-text {
            color: white;
            text-align: center;
            margin-top: 10px;
            font-size: 16px;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.8);
        }

        /* æ‰‹å‹¢å‹•ç•« */
        .hand-guide {
            position: absolute;
            top: 50%;
            left: 20%;
            transform: translate(-50%, -50%);
            font-size: 80px;
            animation: handMove 3s ease-in-out infinite;
            opacity: 0;
        }

        .hand-guide.active {
            opacity: 0.8;
        }

        @keyframes handMove {
            0%, 100% { 
                left: 20%;
                transform: translate(-50%, -50%) rotate(-10deg);
            }
            50% { 
                left: 80%;
                transform: translate(-50%, -50%) rotate(10deg);
            }
        }

        /* æŒ‰éˆ• */
        .button-container {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 30;
            pointer-events: all;
        }

        .btn {
            padding: 18px 40px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
            transition: all 0.3s;
            margin: 0 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00ff88, #00d4ff);
            color: #000;
        }

        .btn-primary:active {
            transform: scale(0.95);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            backdrop-filter: blur(10px);
        }

        /* éšæ®µæŒ‡ç¤ºå™¨ */
        .stage-indicator {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 30;
        }

        .stage-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transition: all 0.3s;
        }

        .stage-dot.active {
            background: #00ff88;
            box-shadow: 0 0 15px #00ff88;
            transform: scale(1.3);
        }

        .stage-dot.completed {
            background: #00ff88;
        }

        /* åµæ¸¬åˆ°çš„ç‰©é«”æ¨™è¨˜ */
        .object-marker {
            position: absolute;
            border: 3px solid #ff00ff;
            border-radius: 10px;
            background: rgba(255, 0, 255, 0.2);
            box-shadow: 
                inset 0 0 20px rgba(255, 0, 255, 0.3),
                0 0 20px rgba(255, 0, 255, 0.5);
            pointer-events: none;
            z-index: 15;
        }

        .object-label {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 0, 255, 0.9);
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            white-space: nowrap;
        }

        /* æˆåŠŸå‹•ç•« */
        .success-overlay {
            position: absolute;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 255, 136, 0.2);
            z-index: 40;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .success-overlay.show {
            display: flex;
            animation: successFade 1s ease-out;
        }

        @keyframes successFade {
            0% { opacity: 0; }
            50% { opacity: 1; }
            100% { opacity: 0; }
        }

        .success-message {
            background: rgba(0, 0, 0, 0.9);
            padding: 40px 60px;
            border-radius: 20px;
            text-align: center;
            color: white;
        }

        .success-message .icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .success-message h2 {
            color: #00ff88;
            font-size: 32px;
            margin-bottom: 10px;
        }

        /* éš±è—å…ƒç´  */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- ç›¸æ©Ÿé è¦½ -->
    <video id="camera" autoplay playsinline></video>

    <!-- é®ç½© -->
    <div class="overlay"></div>

    <!-- éšæ®µæŒ‡ç¤ºå™¨ -->
    <div class="stage-indicator">
        <div class="stage-dot active"></div>
        <div class="stage-dot"></div>
        <div class="stage-dot"></div>
    </div>

    <!-- å¼•å°å‹•ç•« -->
    <div class="guide-container">
        <div class="scan-frame"></div>
        <div class="scan-line" id="scanLine"></div>
        <div class="hand-guide" id="handGuide">ğŸ‘‰</div>
    </div>

    <!-- æç¤ºæ–‡å­— -->
    <div class="instruction" id="instruction">
        <h2>æº–å‚™æƒæç©ºé–“</h2>
        <div class="step">ğŸ“± å°‡æ‰‹æ©Ÿæ°´å¹³æ‹¿å¥½</div>
        <div class="step">ğŸ‘€ å°æº–è¦æŠ•å½±çš„ç‰†é¢</div>
    </div>

    <!-- é€²åº¦æ¢ -->
    <div class="progress-container">
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-text" id="progressText">æº–å‚™ä¸­...</div>
    </div>

    <!-- æŒ‰éˆ• -->
    <div class="button-container">
        <button class="btn btn-primary" id="startBtn" onclick="startScan()">
            é–‹å§‹æƒæ
        </button>
        <button class="btn btn-secondary hidden" id="retryBtn" onclick="retryScan()">
            é‡æ–°æƒæ
        </button>
        <button class="btn btn-primary hidden" id="completeBtn" onclick="completeScan()">
            å®Œæˆè¨­å®š
        </button>
    </div>

    <!-- æˆåŠŸå‹•ç•« -->
    <div class="success-overlay" id="successOverlay">
        <div class="success-message">
            <div class="icon">âœ¨</div>
            <h2>ç©ºé–“æƒæå®Œæˆ!</h2>
            <p>å·²åµæ¸¬åˆ° <span id="objectCount">0</span> å€‹éšœç¤™ç‰©</p>
        </div>
    </div>

    <!-- åµæ¸¬åˆ°çš„ç‰©é«”å®¹å™¨ -->
    <div id="objectsContainer"></div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let stage = 0; // 0: æº–å‚™, 1: æƒæä¸­, 2: å®Œæˆ
        let scanProgress = 0;
        let detectedObjects = [];
        let isScanning = false;
        let scanInterval = null;
        let motionData = {
            startX: 0,
            currentX: 0,
            isMoving: false
        };

        // åˆå§‹åŒ–
        async function init() {
            console.log('ğŸ¬ ç©ºé–“æƒæç³»çµ±å•Ÿå‹•');
            
            // è«‹æ±‚ç›¸æ©Ÿæ¬Šé™
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment', // å¾Œç½®ç›¸æ©Ÿ
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                });
                
                document.getElementById('camera').srcObject = stream;
                console.log('âœ… ç›¸æ©Ÿå•Ÿå‹•æˆåŠŸ');
            } catch (error) {
                console.error('âŒ ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—:', error);
                alert('ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿã€‚è«‹ç¢ºèªå·²å…è¨±ç›¸æ©Ÿæ¬Šé™ã€‚');
            }

            // è«‹æ±‚é™€èºå„€æ¬Šé™ (iOS 13+)
            if (typeof DeviceOrientationEvent !== 'undefined' && 
                typeof DeviceOrientationEvent.requestPermission === 'function') {
                // iOS éœ€è¦ç”¨æˆ¶äº’å‹•æ‰èƒ½è«‹æ±‚æ¬Šé™,ç¨å¾Œåœ¨æŒ‰éˆ•é»æ“Šæ™‚è«‹æ±‚
            } else {
                // Android ç›´æ¥ç›£è½
                setupMotionListeners();
            }
        }

        // è¨­å®šå‹•ä½œæ„Ÿæ¸¬å™¨
        function setupMotionListeners() {
            window.addEventListener('deviceorientation', (event) => {
                if (isScanning) {
                    handleDeviceOrientation(event);
                }
            });

            console.log('âœ… å‹•ä½œæ„Ÿæ¸¬å™¨å·²å•Ÿå‹•');
        }

        // è™•ç†è£ç½®æ–¹å‘
        function handleDeviceOrientation(event) {
            const gamma = event.gamma; // å·¦å³å‚¾æ–œ (-90 åˆ° 90)
            
            if (!motionData.isMoving) {
                motionData.startX = gamma;
                motionData.isMoving = true;
            }

            motionData.currentX = gamma;
            
            // è¨ˆç®—ç§»å‹•è·é›¢
            const movement = Math.abs(motionData.currentX - motionData.startX);
            
            // æ›´æ–°æƒæé€²åº¦
            if (movement > 0) {
                scanProgress = Math.min((movement / 60) * 100, 100); // 60åº¦ç‚ºæ»¿é€²åº¦
                updateProgress(scanProgress);
                
                // æ¨¡æ“¬åµæ¸¬ç‰©é«”
                if (scanProgress > 30 && detectedObjects.length === 0) {
                    addDetectedObject(30, 40, 20, 30, 'æ›¸æ«ƒ');
                }
                if (scanProgress > 60 && detectedObjects.length === 1) {
                    addDetectedObject(60, 30, 15, 20, 'ç›¸æ¡†');
                }
                if (scanProgress > 90 && detectedObjects.length === 2) {
                    addDetectedObject(15, 60, 25, 15, 'æ¡Œå­');
                }
            }
        }

        // é–‹å§‹æƒæ
        async function startScan() {
            console.log('ğŸš€ é–‹å§‹æƒæ');
            
            // iOS è«‹æ±‚é™€èºå„€æ¬Šé™
            if (typeof DeviceOrientationEvent !== 'undefined' && 
                typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const permission = await DeviceOrientationEvent.requestPermission();
                    if (permission === 'granted') {
                        setupMotionListeners();
                    } else {
                        alert('éœ€è¦é™€èºå„€æ¬Šé™æ‰èƒ½é€²è¡Œæƒæ');
                        return;
                    }
                } catch (error) {
                    console.error('æ¬Šé™è«‹æ±‚å¤±æ•—:', error);
                }
            }

            stage = 1;
            isScanning = true;
            updateStage();

            // æ›´æ–° UI
            document.getElementById('startBtn').classList.add('hidden');
            document.getElementById('retryBtn').classList.remove('hidden');
            
            document.getElementById('instruction').innerHTML = `
                <h2>æ…¢æ…¢å¾å·¦æƒåˆ°å³</h2>
                <div class="step">ğŸ“± ä¿æŒæ‰‹æ©Ÿæ°´å¹³</div>
                <div class="step">ğŸ‘‰ ç·©æ…¢ç§»å‹•,ä¸è¦å¤ªå¿«</div>
            `;

            // å•Ÿå‹•è¦–è¦ºæç¤º
            document.getElementById('scanLine').classList.add('active');
            document.getElementById('handGuide').classList.add('active');

            // æ¨¡æ“¬æƒæ(å¦‚æœæ²’æœ‰é™€èºå„€)
            if (!window.DeviceOrientationEvent) {
                startMockScan();
            }
        }

        // æ¨¡æ“¬æƒæ(æ¸¬è©¦ç”¨)
        function startMockScan() {
            scanInterval = setInterval(() => {
                scanProgress += 2;
                updateProgress(scanProgress);

                if (scanProgress >= 30 && detectedObjects.length === 0) {
                    addDetectedObject(30, 40, 20, 30, 'æ›¸æ«ƒ');
                }
                if (scanProgress >= 60 && detectedObjects.length === 1) {
                    addDetectedObject(60, 30, 15, 20, 'ç›¸æ¡†');
                }
                if (scanProgress >= 90 && detectedObjects.length === 2) {
                    addDetectedObject(15, 60, 25, 15, 'æ¡Œå­');
                }

                if (scanProgress >= 100) {
                    clearInterval(scanInterval);
                    finishScan();
                }
            }, 100);
        }

        // æ›´æ–°é€²åº¦
        function updateProgress(progress) {
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent = 
                `æƒæé€²åº¦: ${Math.round(progress)}%`;

            if (progress >= 100 && isScanning) {
                finishScan();
            }
        }

        // å®Œæˆæƒæ
        function finishScan() {
            console.log('âœ… æƒæå®Œæˆ');
            isScanning = false;
            stage = 2;
            updateStage();

            // åœæ­¢å‹•ç•«
            document.getElementById('scanLine').classList.remove('active');
            document.getElementById('handGuide').classList.remove('active');

            // æ›´æ–° UI
            document.getElementById('instruction').innerHTML = `
                <h2>æƒæå®Œæˆ!</h2>
                <div class="step">âœ… å·²åµæ¸¬åˆ° ${detectedObjects.length} å€‹éšœç¤™ç‰©</div>
                <div class="step">ğŸ® è§’è‰²å°‡èƒ½åœ¨é€™äº›ç‰©é«”ä¸Šå½ˆè·³</div>
            `;

            document.getElementById('retryBtn').classList.remove('hidden');
            document.getElementById('completeBtn').classList.remove('hidden');

            // é¡¯ç¤ºæˆåŠŸå‹•ç•«
            showSuccessAnimation();
        }

        // æ·»åŠ åµæ¸¬åˆ°çš„ç‰©é«”
        function addDetectedObject(x, y, width, height, name) {
            const obj = { x, y, width, height, name };
            detectedObjects.push(obj);

            // å‰µå»ºè¦–è¦ºæ¨™è¨˜
            const marker = document.createElement('div');
            marker.className = 'object-marker';
            marker.style.left = x + '%';
            marker.style.top = y + '%';
            marker.style.width = width + '%';
            marker.style.height = height + '%';

            const label = document.createElement('div');
            label.className = 'object-label';
            label.textContent = name;
            marker.appendChild(label);

            document.getElementById('objectsContainer').appendChild(marker);

            console.log('ğŸ¯ åµæ¸¬åˆ°ç‰©é«”:', name);
        }

        // é¡¯ç¤ºæˆåŠŸå‹•ç•«
        function showSuccessAnimation() {
            const overlay = document.getElementById('successOverlay');
            document.getElementById('objectCount').textContent = detectedObjects.length;
            overlay.classList.add('show');

            setTimeout(() => {
                overlay.classList.remove('show');
            }, 2000);
        }

        // é‡æ–°æƒæ
        function retryScan() {
            console.log('ğŸ”„ é‡æ–°æƒæ');
            
            // é‡ç½®ç‹€æ…‹
            stage = 0;
            scanProgress = 0;
            detectedObjects = [];
            isScanning = false;
            motionData = {
                startX: 0,
                currentX: 0,
                isMoving: false
            };

            // æ¸…é™¤è¦–è¦ºæ¨™è¨˜
            document.getElementById('objectsContainer').innerHTML = '';
            
            // é‡ç½® UI
            updateProgress(0);
            updateStage();
            
            document.getElementById('startBtn').classList.remove('hidden');
            document.getElementById('retryBtn').classList.add('hidden');
            document.getElementById('completeBtn').classList.add('hidden');
            document.getElementById('scanLine').classList.remove('active');
            document.getElementById('handGuide').classList.remove('active');

            document.getElementById('instruction').innerHTML = `
                <h2>æº–å‚™æƒæç©ºé–“</h2>
                <div class="step">ğŸ“± å°‡æ‰‹æ©Ÿæ°´å¹³æ‹¿å¥½</div>
                <div class="step">ğŸ‘€ å°æº–è¦æŠ•å½±çš„ç‰†é¢</div>
            `;
        }

        // å®Œæˆè¨­å®š
        function completeScan() {
            console.log('ğŸ’¾ å„²å­˜è¨­å®š:', detectedObjects);

            // å„²å­˜åˆ° localStorage
            localStorage.setItem('scannedObjects', JSON.stringify(detectedObjects));

            // å‚³é€åˆ°éŠæˆ²ç³»çµ±
            sendToGameSystem();

            // è¿”å›éŠæˆ²
            alert('âœ… ç©ºé–“è¨­å®šå®Œæˆ!\n\nè§’è‰²å°‡èƒ½åœ¨çœŸå¯¦ç‰©é«”ä¸Šå½ˆè·³ã€‚\n\né»æ“Šç¢ºå®šè¿”å›éŠæˆ²ã€‚');
            window.location.href = '/game-ws.html?mode=display';
        }

        // å‚³é€åˆ°éŠæˆ²ç³»çµ±
        function sendToGameSystem() {
            // é€é WebSocket å‚³é€
            const data = {
                type: 'SPACE_SCAN',
                objects: detectedObjects,
                timestamp: Date.now()
            };

            // å¦‚æœæœ‰ WebSocket é€£ç·š,ç›´æ¥å‚³é€
            if (window.opener) {
                window.opener.postMessage(data, '*');
            }

            console.log('ğŸ“¤ å·²å‚³é€æƒæè³‡æ–™åˆ°éŠæˆ²ç³»çµ±');
        }

        // æ›´æ–°éšæ®µæŒ‡ç¤ºå™¨
        function updateStage() {
            const dots = document.querySelectorAll('.stage-dot');
            dots.forEach((dot, index) => {
                dot.classList.remove('active', 'completed');
                if (index < stage) {
                    dot.classList.add('completed');
                } else if (index === stage) {
                    dot.classList.add('active');
                }
            });
        }

        // å•Ÿå‹•
        window.addEventListener('load', init);
    </script>
</body>
</html>
